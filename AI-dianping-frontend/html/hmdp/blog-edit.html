<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"
    />
    <title>黑马点评 - 发布笔记</title>
    <link rel="stylesheet" href="./css/element.css" />
    <link href="./css/main.css" rel="stylesheet" />
    <link href="./css/glass.css" rel="stylesheet" />
    <link href="./css/blog-edit.css?v=1.0" rel="stylesheet" />
    <link href="./css/ai-assistant.css" rel="stylesheet" />
  </head>
  <body>
    <div id="app">
      <div class="header">
        <div class="header-cancel-btn" @click="goBack">取消</div>
        <div class="header-title">
          &nbsp;&nbsp;发笔记<i class="el-icon-info"></i>
        </div>
        <div class="header-commit">
          <div class="header-commit-btn" @click="submitBlog">发布</div>
        </div>
      </div>

      <div class="page-wrapper">
        <div class="content-card upload-box">
          <div class="section-header">
            <div>
              <div class="section-title">图集素材</div>
              <div class="section-subtitle">点击下方上传旅拍或探店照片</div>
            </div>
            <div class="section-pill" v-if="fileList.length">
              {{fileList.length}} 张
            </div>
          </div>
          <input
            type="file"
            @change="fileSelected"
            name="file"
            ref="fileInput"
            style="display: none"
          />
          <div class="upload-btn" @click="openFileDialog">
            <i class="el-icon-camera"></i>
            <div class="upload-tip">上传照片</div>
          </div>
          <div class="pic-list">
            <div class="pic-box" v-for="(f,i) in fileList" :key="i">
              <img :src="f" alt="" />
              <i class="el-icon-close" @click="deletePic(i)"></i>
            </div>
          </div>
        </div>

        <div class="content-card blog-title">
          <label class="section-title" for="blog-title-input">笔记标题</label>
          <input
            id="blog-title-input"
            v-model="params.title"
            type="text"
            placeholder="填写标题更容易上首页哦~"
          />
        </div>

        <div class="content-card blog-content">
          <label class="section-title" for="blog-content-input">正文内容</label>
          <textarea
            id="blog-content-input"
            v-model="params.content"
            placeholder="最近打卡了什么地方，有什么新奇体验呢？"
          ></textarea>
        </div>

        <div class="content-card blog-shop-card" @click="showDialog=true">
          <div class="blog-shop">
            <div class="shop-left">关联商户</div>
            <div v-if="selectedShop.name">{{selectedShop.name}}</div>
            <div v-else>去选择&nbsp;<i class="el-icon-arrow-right"></i></div>
          </div>
        </div>
      </div>

      <div class="mask" v-show="showDialog" @click="showDialog=false"></div>

      <transition name="el-zoom-in-bottom">
        <div class="shop-dialog" v-show="showDialog">
          <div class="blog-shop">
            <div class="shop-left">关联商户</div>
          </div>
          <div class="search-bar">
            <div class="city-select">
              杭州 <i class="el-icon-arrow-down"></i>
            </div>
            <div class="search-input">
              <i class="el-icon-search" @click="queryShops"></i>
              <input
                v-model="shopName"
                type="text"
                placeholder="搜索商户名称"
              />
            </div>
          </div>
          <div class="shop-list">
            <div v-for="s in shops" class="shop-item" @click="selectShop(s)">
              <div class="shop-name">{{s.name}}</div>
              <div>{{s.area}}</div>
            </div>
          </div>
        </div>
      </transition>
    </div>
    <div class="ai-launcher">
      <a
        class="ai-launcher-button"
        href="./aiassistant.html"
        title="打开AI顾问"
      >
        <svg viewBox="0 0 48 48" aria-hidden="true">
          <defs>
            <linearGradient
              id="ai-icon-gradient"
              x1="0%"
              y1="0%"
              x2="100%"
              y2="100%"
            >
              <stop offset="0%" stop-color="#60a5fa"></stop>
              <stop offset="100%" stop-color="#a855f7"></stop>
            </linearGradient>
          </defs>
          <circle cx="24" cy="24" r="18" fill="rgba(255,255,255,0.22)"></circle>
          <path
            d="M17 18c0-3.314 2.686-6 6-6h2c3.314 0 6 2.686 6 6 0 1.824-.82 3.453-2.108 4.551-.26.221-.26.675 0 .896C29.18 24.545 30 26.175 30 28c0 3.314-2.686 6-6 6h-2c-3.314 0-6-2.686-6-6 0-1.825.82-3.455 2.108-4.553.26-.221.26-.675 0-.896C17.82 21.454 17 19.824 17 18Z"
            stroke="url(#ai-icon-gradient)"
            stroke-width="2.6"
            stroke-linecap="round"
            stroke-linejoin="round"
            fill="none"
          ></path>
          <circle
            cx="20"
            cy="18"
            r="1.8"
            fill="url(#ai-icon-gradient)"
          ></circle>
          <circle
            cx="28"
            cy="18"
            r="1.8"
            fill="url(#ai-icon-gradient)"
          ></circle>
          <path
            d="M20 28h8"
            stroke="url(#ai-icon-gradient)"
            stroke-width="2.6"
            stroke-linecap="round"
          ></path>
        </svg>
      </a>
    </div>

    <script src="./js/vue.js"></script>
    <script src="./js/axios.min.js"></script>
    <script src="./js/element.js"></script>
    <script src="./js/common.js"></script>
    <script src="./js/footer.js"></script>
    <script>
      const app = new Vue({
        el: "#app",
        data() {
          return {
            util,
            fileList: [],
            params: {},
            showDialog: false,
            shops: [],
            shopName: "",
            selectedShop: {},
          };
        },
        created() {
          this.checkLogin();
          this.queryShops();
        },
        methods: {
          queryShops() {
            axios
              .get("/shop/of/name?name=" + this.shopName)
              .then(({ data }) => (this.shops = data))
              .catch(this.$message.error);
          },
          selectShop(s) {
            this.selectedShop = s;
            this.showDialog = false;
          },
          submitBlog() {
            let { ...data } = this.params;
            data.images = this.fileList.join(",");
            data.shopId = this.selectedShop.id;
            axios
              .post("/blog", data)
              .then((resp) => (location.href = "/info.html"))
              .catch(this.$message.error);
          },
          openFileDialog() {
            this.$refs.fileInput.click();
          },
          fileSelected() {
            let file = this.$refs.fileInput.files[0];
            let formData = new FormData();
            formData.append("file", file);
            axios
              .post("/upload/blog", formData)
              .then(({ data }) => this.fileList.push("/imgs" + data))
              .catch(this.$message.error);
          },
          deletePic(i) {
            axios
              .get("/upload/blog/delete?name=" + this.fileList[i])
              .then(() => this.fileList.splice(i, 1))
              .catch(this.$message.error);
          },
          checkLogin() {
            let token = sessionStorage.getItem("token");
            if (!token) {
              location.href = "login.html";
            }
            axios
              .get("/user/me")
              .then()
              .catch((err) => {
                this.$message.error(err);
                setTimeout(() => (location.href = "login.html"), 200);
              });
          },
          goBack() {
            history.back();
          },
        },
      });
    </script>
  </body>
</html>
